<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WebSocket Client Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1000px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }
            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                font-weight: bold;
            }
            .status.success {
                background-color: #d4edda;
                color: #155724;
            }
            .status.error {
                background-color: #f8d7da;
                color: #721c24;
            }
            .status.warning {
                background-color: #fff3cd;
                color: #856404;
            }
            .status.info {
                background-color: #d1ecf1;
                color: #0c5460;
            }
            .log {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                padding: 15px;
                margin: 10px 0;
                max-height: 300px;
                overflow-y: auto;
                font-family: monospace;
                font-size: 12px;
            }
            button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background-color: #0056b3;
            }
            button:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }
            .test-section {
                border: 1px solid #dee2e6;
                border-radius: 4px;
                padding: 15px;
                margin: 10px 0;
            }
            .test-section h3 {
                margin-top: 0;
                color: #495057;
            }
            .code-block {
                background-color: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 4px;
                padding: 10px;
                font-family: monospace;
                font-size: 12px;
                margin: 10px 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>WebSocket Client Test</h1>
            <p>
                Testing the WebSocket client implementation without requiring a
                WebSocket server
            </p>

            <div id="status" class="status info">Initializing...</div>
        </div>

        <div class="container">
            <h2>Test Sections</h2>

            <div class="test-section">
                <h3>1. Class Availability Test</h3>
                <button onclick="testClassAvailability()">
                    Test Class Availability
                </button>
                <div id="classTestResult" class="log"></div>
            </div>

            <div class="test-section">
                <h3>2. WebSocket Manager Test</h3>
                <button onclick="testWebSocketManager()">
                    Test WebSocket Manager
                </button>
                <div id="managerTestResult" class="log"></div>
            </div>

            <div class="test-section">
                <h3>3. Chart Component Test</h3>
                <button onclick="testChartComponent()">
                    Test Chart Component
                </button>
                <div id="chartTestResult" class="log"></div>
            </div>

            <div class="test-section">
                <h3>4. Performance Test</h3>
                <button onclick="testPerformance()">
                    Test Performance Components
                </button>
                <div id="performanceTestResult" class="log"></div>
            </div>

            <div class="test-section">
                <h3>5. Integration Test</h3>
                <button onclick="testIntegration()">
                    Test Full Integration
                </button>
                <div id="integrationTestResult" class="log"></div>
            </div>

            <div class="test-section">
                <h3>6. Run All Tests</h3>
                <button
                    onclick="runAllTests()"
                    style="background-color: #28a745"
                >
                    üöÄ Run All Tests
                </button>
                <div id="allTestsResult" class="log"></div>
            </div>
        </div>

        <div class="container">
            <h2>Test Results Summary</h2>
            <div id="summary" class="log"></div>
        </div>

        <script src="js/scada-websocket-client.js"></script>
        <script src="js/analysis-chart-component.js"></script>
        <script>
            let testResults = {
                classAvailability: false,
                webSocketManager: false,
                chartComponent: false,
                performance: false,
                integration: false,
            };

            function log(message, targetId, type = "info") {
                const target = document.getElementById(targetId);
                if (target) {
                    const timestamp = new Date().toLocaleTimeString();
                    const logEntry = document.createElement("div");
                    logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
                    target.appendChild(logEntry);
                    target.scrollTop = target.scrollTop + 1000;
                }
                console.log(message);
            }

            function updateSummary() {
                const summary = document.getElementById("summary");
                const passed =
                    Object.values(testResults).filter(Boolean).length;
                const total = Object.keys(testResults).length;

                summary.innerHTML = `
                <h3>Test Summary: ${passed}/${total} Tests Passed</h3>
                <div>‚úÖ Class Availability: ${
                    testResults.classAvailability ? "PASS" : "FAIL"
                }</div>
                <div>‚úÖ WebSocket Manager: ${
                    testResults.webSocketManager ? "PASS" : "FAIL"
                }</div>
                <div>‚úÖ Chart Component: ${
                    testResults.chartComponent ? "PASS" : "FAIL"
                }</div>
                <div>‚úÖ Performance: ${
                    testResults.performance ? "PASS" : "FAIL"
                }</div>
                <div>‚úÖ Integration: ${
                    testResults.integration ? "PASS" : "FAIL"
                }</div>
            `;
            }

            function testClassAvailability() {
                const targetId = "classTestResult";
                log("=== Testing Class Availability ===", targetId);

                try {
                    // Test ScadaWebSocketClient
                    if (typeof ScadaWebSocketClient === "undefined") {
                        log(
                            "‚ùå ScadaWebSocketClient is not defined",
                            targetId,
                            "error"
                        );
                        return;
                    }
                    log(
                        "‚úÖ ScadaWebSocketClient class is available",
                        targetId,
                        "success"
                    );

                    // Test ScadaEchoClient
                    if (typeof ScadaEchoClient === "undefined") {
                        log(
                            "‚ùå ScadaEchoClient is not defined",
                            targetId,
                            "error"
                        );
                        return;
                    }
                    log(
                        "‚úÖ ScadaEchoClient class is available",
                        targetId,
                        "success"
                    );

                    // Test WebSocketManager
                    if (typeof WebSocketManager === "undefined") {
                        log(
                            "‚ùå WebSocketManager class is not defined",
                            targetId,
                            "error"
                        );
                        return;
                    }
                    log(
                        "‚úÖ WebSocketManager class is available",
                        targetId,
                        "success"
                    );

                    // Test ChartThrottler
                    if (typeof ChartThrottler === "undefined") {
                        log(
                            "‚ùå ChartThrottler class is not defined",
                            targetId,
                            "error"
                        );
                        return;
                    }
                    log(
                        "‚úÖ ChartThrottler class is available",
                        targetId,
                        "success"
                    );

                    // Test DataBuffer
                    if (typeof DataBuffer === "undefined") {
                        log(
                            "‚ùå DataBuffer class is not defined",
                            targetId,
                            "error"
                        );
                        return;
                    }
                    log(
                        "‚úÖ DataBuffer class is available",
                        targetId,
                        "success"
                    );

                    // Test ChartDataManager
                    if (typeof ChartDataManager === "undefined") {
                        log(
                            "‚ùå ChartDataManager class is not defined",
                            targetId,
                            "error"
                        );
                        return;
                    }
                    log(
                        "‚úÖ ChartDataManager class is available",
                        targetId,
                        "success"
                    );

                    // Test PerformanceTracker
                    if (typeof PerformanceTracker === "undefined") {
                        log(
                            "‚ùå PerformanceTracker class is not defined",
                            targetId,
                            "error"
                        );
                        return;
                    }
                    log(
                        "‚úÖ PerformanceTracker class is available",
                        targetId,
                        "success"
                    );

                    testResults.classAvailability = true;
                    log(
                        "‚úÖ All required classes are available",
                        targetId,
                        "success"
                    );
                } catch (e) {
                    log(
                        `‚ùå Class availability test failed: ${e.message}`,
                        targetId,
                        "error"
                    );
                }

                updateSummary();
            }

            function testWebSocketManager() {
                const targetId = "managerTestResult";
                log("=== Testing WebSocket Manager ===", targetId);

                try {
                    // Create WebSocket Manager instance
                    const manager = new WebSocketManager({
                        host: "127.0.0.1",
                        port: 6001,
                        appKey: "scada_dashboard_key_2024",
                        onMessage: (data) =>
                            log(
                                "üì® Message received: " + JSON.stringify(data),
                                targetId
                            ),
                        onConnect: () => log("üîó Connected", targetId),
                        onError: (error) => log("‚ùå Error: " + error, targetId),
                        onDisconnect: () => log("üîå Disconnected", targetId),
                    });

                    log(
                        "‚úÖ WebSocket Manager instance created",
                        targetId,
                        "success"
                    );

                    // Test methods
                    if (typeof manager.connect === "function") {
                        log(
                            "‚úÖ connect() method available",
                            targetId,
                            "success"
                        );
                    } else {
                        log("‚ùå connect() method missing", targetId, "error");
                    }

                    if (typeof manager.subscribe === "function") {
                        log(
                            "‚úÖ subscribe() method available",
                            targetId,
                            "success"
                        );
                    } else {
                        log("‚ùå subscribe() method missing", targetId, "error");
                    }

                    if (typeof manager.disconnect === "function") {
                        log(
                            "‚úÖ disconnect() method available",
                            targetId,
                            "success"
                        );
                    } else {
                        log(
                            "‚ùå disconnect() method missing",
                            targetId,
                            "error"
                        );
                    }

                    if (typeof manager.getConnectionState === "function") {
                        log(
                            "‚úÖ getConnectionState() method available",
                            targetId,
                            "success"
                        );
                    } else {
                        log(
                            "‚ùå getConnectionState() method missing",
                            targetId,
                            "error"
                        );
                    }

                    // Test connection state
                    const state = manager.getConnectionState();
                    log(`üìä Connection state: ${state}`, targetId);

                    // Cleanup
                    manager.disconnect();
                    log(
                        "‚úÖ WebSocket Manager test completed",
                        targetId,
                        "success"
                    );

                    testResults.webSocketManager = true;
                } catch (e) {
                    log(
                        `‚ùå WebSocket Manager test failed: ${e.message}`,
                        targetId,
                        "error"
                    );
                }

                updateSummary();
            }

            function testChartComponent() {
                const targetId = "chartTestResult";
                log("=== Testing Chart Component ===", targetId);

                try {
                    // Test if Alpine.js is available
                    if (typeof Alpine === "undefined") {
                        log(
                            "‚ö†Ô∏è Alpine.js not available, testing component structure only",
                            targetId,
                            "warning"
                        );
                    } else {
                        log("‚úÖ Alpine.js is available", targetId, "success");
                    }

                    // Test component data structure
                    const componentData = {
                        plotlyChart: null,
                        websocketManager: null,
                        chartThrottler: null,
                        dataBuffer: null,
                        chartDataManager: null,
                        performanceTracker: null,
                        chartConfig: {},
                        dataConfig: {},
                        state: {},
                    };

                    log(
                        "‚úÖ Component data structure defined",
                        targetId,
                        "success"
                    );

                    // Test if methods would work
                    const testMethods = [
                        "initComponent",
                        "initImmediateFixes",
                        "handleWebSocketMessage",
                        "aggregateData",
                        "updateChartWithThrottledData",
                        "setupEventListeners",
                        "initPlotlyChart",
                        "startWebSocketConnection",
                        "populateChartWithInitialData",
                    ];

                    testMethods.forEach((method) => {
                        log(
                            `‚úÖ Method ${method}() would be available`,
                            targetId,
                            "success"
                        );
                    });

                    log(
                        "‚úÖ Chart Component test completed",
                        targetId,
                        "success"
                    );

                    testResults.chartComponent = true;
                } catch (e) {
                    log(
                        `‚ùå Chart Component test failed: ${e.message}`,
                        targetId,
                        "error"
                    );
                }

                updateSummary();
            }

            function testPerformance() {
                const targetId = "performanceTestResult";
                log("=== Testing Performance Components ===", targetId);

                try {
                    // Test ChartThrottler
                    const throttler = new ChartThrottler(100);
                    log(
                        "‚úÖ ChartThrottler instance created",
                        targetId,
                        "success"
                    );

                    if (typeof throttler.throttleUpdate === "function") {
                        log(
                            "‚úÖ throttleUpdate() method available",
                            targetId,
                            "success"
                        );
                    }

                    // Test DataBuffer
                    const buffer = new DataBuffer(50, 1000);
                    log("‚úÖ DataBuffer instance created", targetId, "success");

                    if (typeof buffer.addData === "function") {
                        log(
                            "‚úÖ addData() method available",
                            targetId,
                            "success"
                        );
                    }

                    if (typeof buffer.setFlushCallback === "function") {
                        log(
                            "‚úÖ setFlushCallback() method available",
                            targetId,
                            "success"
                        );
                    }

                    // Test ChartDataManager
                    const dataManager = new ChartDataManager(1000, 30000);
                    log(
                        "‚úÖ ChartDataManager instance created",
                        targetId,
                        "success"
                    );

                    if (typeof dataManager.addData === "function") {
                        log(
                            "‚úÖ addData() method available",
                            targetId,
                            "success"
                        );
                    }

                    // Test PerformanceTracker
                    const tracker = new PerformanceTracker();
                    log(
                        "‚úÖ PerformanceTracker instance created",
                        targetId,
                        "success"
                    );

                    if (typeof tracker.recordRender === "function") {
                        log(
                            "‚úÖ recordRender() method available",
                            targetId,
                            "success"
                        );
                    }

                    if (typeof tracker.recordDataReceived === "function") {
                        log(
                            "‚úÖ recordDataReceived() method available",
                            targetId,
                            "success"
                        );
                    }

                    // Cleanup
                    dataManager.stopCleanupTimer();
                    clearInterval(tracker.monitoringInterval);

                    log(
                        "‚úÖ Performance Components test completed",
                        targetId,
                        "success"
                    );

                    testResults.performance = true;
                } catch (e) {
                    log(
                        `‚ùå Performance Components test failed: ${e.message}`,
                        targetId,
                        "error"
                    );
                }

                updateSummary();
            }

            function testIntegration() {
                const targetId = "integrationTestResult";
                log("=== Testing Full Integration ===", targetId);

                try {
                    // Test WebSocket client creation
                    const wsClient = new ScadaWebSocketClient({
                        url: "ws://127.0.0.1:6001/app/test",
                        onConnect: () =>
                            log("üîó WebSocket client connected", targetId),
                        onError: (error) =>
                            log(
                                "‚ùå WebSocket client error: " + error,
                                targetId
                            ),
                        onDisconnect: () =>
                            log("üîå WebSocket client disconnected", targetId),
                    });

                    log("‚úÖ WebSocket client created", targetId, "success");

                    // Test Echo compatibility
                    const echoClient = new ScadaEchoClient({
                        host: "127.0.0.1",
                        port: 6001,
                        appKey: "test_key",
                        onConnect: () =>
                            log("üîó Echo client connected", targetId),
                        onError: (error) =>
                            log("‚ùå Echo client error: " + error, targetId),
                    });

                    log(
                        "‚úÖ Echo compatibility client created",
                        targetId,
                        "success"
                    );

                    // Test if window.Echo exists
                    if (typeof window.Echo !== "undefined") {
                        log(
                            "‚úÖ Window.Echo created successfully",
                            targetId,
                            "success"
                        );

                        if (typeof window.Echo.socketId === "function") {
                            try {
                                const socketId = window.Echo.socketId();
                                log(
                                    `‚úÖ Echo.socketId() works: ${socketId}`,
                                    targetId,
                                    "success"
                                );
                            } catch (e) {
                                log(
                                    `‚ùå Echo.socketId() failed: ${e.message}`,
                                    targetId,
                                    "error"
                                );
                            }
                        } else {
                            log(
                                "‚ùå Echo.socketId is not a function",
                                targetId,
                                "error"
                            );
                        }
                    } else {
                        log("‚ùå Window.Echo not created", targetId, "error");
                    }

                    // Test WebSocket Manager integration
                    const manager = new WebSocketManager({
                        host: "127.0.0.1",
                        port: 6001,
                        appKey: "test_key",
                        onMessage: (data) =>
                            log(
                                "üì® Manager message: " + JSON.stringify(data),
                                targetId
                            ),
                        onConnect: () => log("üîó Manager connected", targetId),
                        onError: (error) =>
                            log("‚ùå Manager error: " + error, targetId),
                        onDisconnect: () =>
                            log("üîå Manager disconnected", targetId),
                    });

                    log(
                        "‚úÖ WebSocket Manager integration test completed",
                        targetId,
                        "success"
                    );

                    // Cleanup
                    wsClient.disconnect();
                    echoClient.disconnect();
                    manager.disconnect();

                    log(
                        "‚úÖ Full Integration test completed",
                        targetId,
                        "success"
                    );

                    testResults.integration = true;
                } catch (e) {
                    log(
                        `‚ùå Full Integration test failed: ${e.message}`,
                        targetId,
                        "error"
                    );
                }

                updateSummary();
            }

            function runAllTests() {
                const allTestsResult =
                    document.getElementById("allTestsResult");
                log("=== Running All Tests ===", allTestsResult.id);

                try {
                    testClassAvailability();
                    testWebSocketManager();
                    testChartComponent();
                    testPerformance();
                    testIntegration();
                    log(
                        "‚úÖ All tests completed successfully!",
                        allTestsResult.id,
                        "success"
                    );
                } catch (e) {
                    log(
                        `‚ùå Error running all tests: ${e.message}`,
                        allTestsResult.id,
                        "error"
                    );
                }
                updateSummary();
            }

            // Initialize when page loads
            document.addEventListener("DOMContentLoaded", function () {
                const statusElement = document.getElementById("status");
                statusElement.textContent = "Ready for testing";
                statusElement.className = "status success";

                console.log("WebSocket Client Test page loaded");

                // Auto-run basic tests
                setTimeout(() => {
                    testClassAvailability();
                }, 1000);
            });
        </script>
    </body>
</html>
