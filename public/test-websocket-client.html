<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WebSocket Test - SCADA Dashboard</title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .status {
                padding: 15px;
                margin: 15px 0;
                border-radius: 5px;
                font-weight: bold;
            }
            .status.connected {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .status.disconnected {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .status.connecting {
                background-color: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }
            .button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 12px 24px;
                margin: 10px 5px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            }
            .button:hover {
                background-color: #0056b3;
            }
            .button:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }
            .log {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 5px;
                padding: 15px;
                margin: 20px 0;
                max-height: 300px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 14px;
            }
            .log-entry {
                margin: 5px 0;
                padding: 5px;
                border-radius: 3px;
            }
            .log-entry.info {
                background-color: #e3f2fd;
            }
            .log-entry.success {
                background-color: #e8f5e8;
            }
            .log-entry.error {
                background-color: #ffebee;
            }
            .log-entry.warning {
                background-color: #fff8e1;
            }
            .test-section {
                margin: 30px 0;
                padding: 20px;
                border: 1px solid #dee2e6;
                border-radius: 5px;
            }
            .test-section h3 {
                margin-top: 0;
                color: #495057;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîå WebSocket Connection Test</h1>

            <div class="status disconnected" id="connectionStatus">
                ‚ùå Disconnected
            </div>

            <div style="text-align: center; margin: 20px 0">
                <button
                    class="button"
                    id="connectBtn"
                    onclick="connectWebSocket()"
                >
                    üîó Connect to WebSocket
                </button>
                <button
                    class="button"
                    id="disconnectBtn"
                    onclick="disconnectWebSocket()"
                    disabled
                >
                    üîå Disconnect
                </button>
                <button
                    class="button"
                    id="testBtn"
                    onclick="testConnection()"
                    disabled
                >
                    üß™ Test Connection
                </button>
            </div>

            <div class="test-section">
                <h3>üì° WebSocket Server Status</h3>
                <p>
                    <strong>Server URL:</strong>
                    <code>ws://127.0.0.1:6001</code>
                </p>
                <p><strong>Configuration:</strong> <code>soketi.json</code></p>
                <div id="serverInfo">
                    <p>Click "Connect to WebSocket" to test the connection.</p>
                </div>
            </div>

            <div class="test-section">
                <h3>üìä Connection Log</h3>
                <div class="log" id="logContainer">
                    <div class="log-entry info">
                        Ready to test WebSocket connection...
                    </div>
                </div>
            </div>

            <div class="test-section">
                <h3>üîß Troubleshooting</h3>
                <ul>
                    <li>
                        <strong>Port 6001 not accessible:</strong> Make sure
                        Soketi server is running
                    </li>
                    <li>
                        <strong>Connection refused:</strong> Check if
                        <code>start-websocket-services.bat</code> was executed
                    </li>
                    <li>
                        <strong>WebSocket handshake failed:</strong> Verify
                        <code>soketi.json</code> configuration
                    </li>
                </ul>
            </div>
        </div>

        <script>
            let ws = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            const reconnectDelay = 2000;

            function log(message, type = "info") {
                const logContainer = document.getElementById("logContainer");
                const logEntry = document.createElement("div");
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            function updateStatus(status, message) {
                const statusElement =
                    document.getElementById("connectionStatus");
                statusElement.className = `status ${status}`;
                statusElement.innerHTML = message;
            }

            function updateButtons(connected) {
                document.getElementById("connectBtn").disabled = connected;
                document.getElementById("disconnectBtn").disabled = !connected;
                document.getElementById("testBtn").disabled = !connected;
            }

            function connectWebSocket() {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    log("WebSocket is already connected", "warning");
                    return;
                }

                log("Attempting to connect to WebSocket server...", "info");
                updateStatus("connecting", "üîÑ Connecting...");
                updateButtons(false);

                try {
                    ws = new WebSocket("ws://127.0.0.1:6001");

                    ws.onopen = function (event) {
                        log(
                            "‚úÖ WebSocket connection established successfully!",
                            "success"
                        );
                        updateStatus(
                            "connected",
                            "‚úÖ Connected to WebSocket Server"
                        );
                        updateButtons(true);
                        reconnectAttempts = 0;

                        // Send a test message
                        ws.send(
                            JSON.stringify({
                                type: "test",
                                message: "Hello from WebSocket test client!",
                                timestamp: new Date().toISOString(),
                            })
                        );
                    };

                    ws.onmessage = function (event) {
                        try {
                            const data = JSON.parse(event.data);
                            log(
                                `üì® Received: ${JSON.stringify(data, null, 2)}`,
                                "success"
                            );
                        } catch (e) {
                            log(`üì® Received raw data: ${event.data}`, "info");
                        }
                    };

                    ws.onclose = function (event) {
                        log(
                            `üîå WebSocket connection closed. Code: ${event.code}, Reason: ${event.reason}`,
                            "warning"
                        );
                        updateStatus("disconnected", "‚ùå Disconnected");
                        updateButtons(false);

                        // Attempt to reconnect
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            log(
                                `üîÑ Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`,
                                "info"
                            );
                            setTimeout(connectWebSocket, reconnectDelay);
                        } else {
                            log(
                                "‚ùå Max reconnection attempts reached. Please check server status.",
                                "error"
                            );
                        }
                    };

                    ws.onerror = function (error) {
                        log(
                            `‚ùå WebSocket error: ${
                                error.message || "Unknown error"
                            }`,
                            "error"
                        );
                        updateStatus("disconnected", "‚ùå Connection Error");
                        updateButtons(false);
                    };
                } catch (error) {
                    log(
                        `‚ùå Failed to create WebSocket connection: ${error.message}`,
                        "error"
                    );
                    updateStatus("disconnected", "‚ùå Connection Failed");
                    updateButtons(false);
                }
            }

            function disconnectWebSocket() {
                if (ws) {
                    log("üîå Manually disconnecting WebSocket...", "info");
                    ws.close(1000, "Manual disconnect");
                    ws = null;
                    updateStatus("disconnected", "‚ùå Disconnected");
                    updateButtons(false);
                }
            }

            function testConnection() {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    log("‚ùå WebSocket is not connected", "error");
                    return;
                }

                log("üß™ Testing WebSocket connection...", "info");

                // Send test message
                const testMessage = {
                    type: "ping",
                    message: "Connection test",
                    timestamp: new Date().toISOString(),
                };

                ws.send(JSON.stringify(testMessage));
                log(
                    `üì§ Sent test message: ${JSON.stringify(testMessage)}`,
                    "info"
                );
            }

            // Check if WebSocket is supported
            if (!window.WebSocket) {
                log("‚ùå WebSocket is not supported in this browser", "error");
                updateStatus("disconnected", "‚ùå WebSocket Not Supported");
            } else {
                log("‚úÖ WebSocket is supported in this browser", "success");
            }

            // Auto-connect after page load
            window.addEventListener("load", function () {
                log(
                    "üöÄ Page loaded, ready to test WebSocket connection",
                    "info"
                );
            });
        </script>
    </body>
</html>
